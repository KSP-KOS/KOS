<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>PID Loops in kOS &mdash; kOS 0.15.3 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.15.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="top" title="kOS 0.15.3 documentation" href="../index.html" />
    <link rel="up" title="Tutorials" href="../tutorials.html" />
    <link rel="next" title="General Topics" href="../general.html" />
    <link rel="prev" title="Design Patterns and Considerations with kOS" href="designpatterns.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../general.html" title="General Topics"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="designpatterns.html" title="Design Patterns and Considerations with kOS"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">kOS 0.15.3 documentation</a> &raquo;</li>
          <li><a href="../tutorials.html" accesskey="U">Tutorials</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="pid-loops-in-kos">
<span id="pidloops"></span><h1>PID Loops in kOS<a class="headerlink" href="#pid-loops-in-kos" title="Permalink to this headline">¶</a></h1>
<p>This tutorial covers how one can implement a <a class="reference external" href="http://en.wikipedia.org/wiki/PID_controller">PID loop</a> using kOS. A P-loop, or &#8220;proportional feedback loop&#8221; was already introduced in the second section of the <a class="reference internal" href="designpatterns.html#designpatterns"><em>Design Patterns Tutorial</em></a>, and that will serve as our starting point. After some code rearrangement, the integral and derivative terms will be added and discussed in turn. Next, a couple extra features will be added to the full PID-loop. Lastly, we&#8217;ll show a case-study in tuning a full PID loop using the Ziegler-Nichols method. We&#8217;ll use the LOG method to dump telemetry from KSP into a file and our favorite graphing software to visualize the data.</p>
<p>The code examples in this tutorial can be tested with a similar rocket design as shown. Do not forget the accelerometer, gravioli detector or the kOS CPU module. The engine is purposefully overpowered to demonstrate the feedback in action.</p>
<div class="figure">
<img alt="../_images/pidtune_rocket_design_maxtwr8.png" src="../_images/pidtune_rocket_design_maxtwr8.png" />
</div>
<p>Those fuel-tank adapters are from the <a class="reference external" href="https://kerbalstuff.com/mod/148/Modular%20Rocket%20Systems%20-%20Parts%20Pack">Modular Rocket Systems (MRS) addon</a>, but stock tanks will work just fine. The design goal of this rocket is to have a TWR of 8 on the launchpad and enough fuel to make it past 30km when throttled for optimal atmospheric efficiency.</p>
<div class="contents local topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#proportional-feedback-loop-p-loop" id="id1">Proportional Feedback Loop (P-loop)</a></li>
<li><a class="reference internal" href="#proportional-integral-feedback-loop-pi-loop" id="id2">Proportional-Integral Feedback Loop (PI-loop)</a></li>
<li><a class="reference internal" href="#proportional-integral-derivative-feedback-loop-pid-loop" id="id3">Proportional-Integral-Derivative Feedback Loop (PID-loop)</a></li>
<li><a class="reference internal" href="#final-touches" id="id4">Final Touches</a></li>
<li><a class="reference internal" href="#tuning-a-pid-loop" id="id5">Tuning a PID-loop</a></li>
<li><a class="reference internal" href="#final-thoughts" id="id6">Final Thoughts</a></li>
</ul>
</div>
<div class="section" id="proportional-feedback-loop-p-loop">
<h2><a class="toc-backref" href="#id1">Proportional Feedback Loop (P-loop)</a><a class="headerlink" href="#proportional-feedback-loop-p-loop" title="Permalink to this headline">¶</a></h2>
<p>The example code from the <a class="reference internal" href="designpatterns.html#designpatterns"><em>Design Patterns Tutorial</em></a>, with some slight modifications looks like the following:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="c1">// staging, throttle, steering, go</span>
<span class="n">WHEN</span> <span class="n">STAGE</span><span class="o">:</span><span class="n">LIQUIDFUEL</span> <span class="o">&lt;</span> <span class="mf">0.1</span> <span class="n">THEN</span> <span class="p">{</span>
    <span class="n">STAGE</span><span class="p">.</span>
    <span class="n">PRESERVE</span><span class="p">.</span>
<span class="p">}</span>
<span class="n">LOCK</span> <span class="n">THROTTLE</span> <span class="n">TO</span> <span class="mf">1.</span>
<span class="n">LOCK</span> <span class="n">STEERING</span> <span class="n">TO</span> <span class="n">R</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">90</span><span class="p">)</span> <span class="o">+</span> <span class="n">HEADING</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span><span class="mi">90</span><span class="p">).</span>
<span class="n">STAGE</span><span class="p">.</span>
<span class="n">WAIT</span> <span class="n">UNTIL</span> <span class="n">SHIP</span><span class="o">:</span><span class="n">ALTITUDE</span> <span class="o">&gt;</span> <span class="mf">1000.</span>

<span class="c1">// P-loop setup</span>
<span class="n">SET</span> <span class="n">g</span> <span class="n">TO</span> <span class="n">KERBIN</span><span class="o">:</span><span class="n">MU</span> <span class="o">/</span> <span class="n">KERBIN</span><span class="o">:</span><span class="n">RADIUS</span><span class="o">^</span><span class="mf">2.</span>
<span class="n">LOCK</span> <span class="n">accvec</span> <span class="n">TO</span> <span class="n">SHIP</span><span class="o">:</span><span class="n">SENSORS</span><span class="o">:</span><span class="n">ACC</span> <span class="o">-</span> <span class="n">SHIP</span><span class="o">:</span><span class="n">SENSORS</span><span class="o">:</span><span class="n">GRAV</span><span class="p">.</span>
<span class="n">LOCK</span> <span class="n">gforce</span> <span class="n">TO</span> <span class="n">accvec</span><span class="o">:</span><span class="n">MAG</span> <span class="o">/</span> <span class="n">g</span><span class="p">.</span>
<span class="n">LOCK</span> <span class="n">dthrott</span> <span class="n">TO</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.2</span> <span class="o">-</span> <span class="n">gforce</span><span class="p">).</span>

<span class="n">SET</span> <span class="n">thrott</span> <span class="n">TO</span> <span class="mf">1.</span>
<span class="n">LOCK</span> <span class="n">THROTTLE</span> <span class="n">to</span> <span class="n">thrott</span><span class="p">.</span>

<span class="n">UNTIL</span> <span class="n">SHIP</span><span class="o">:</span><span class="n">ALTITUDE</span> <span class="o">&gt;</span> <span class="mi">40000</span> <span class="p">{</span>
    <span class="n">SET</span> <span class="n">thrott</span> <span class="n">to</span> <span class="n">thrott</span> <span class="o">+</span> <span class="n">dthrott</span><span class="p">.</span>
    <span class="n">WAIT</span> <span class="mf">0.1</span><span class="p">.</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The first several lines sets up a simple staging condition, puts the throttle to maximum, steers the rocket straight up and launches. The rocket is assumed to use only liquid fuel engines. After the rocket hits 1km, the script sets up the LOCK used in the P-loop which is updated every 0.1 seconds in the UNTIL loop. The use of LOCK variables makes this code fairly clean. When the script comes up to the first line in the UNTIL loop, i.e. &#8220;SET thrott TO thrott + dthrott.&#8221;, the variable dthrott is evaluated which causes the LOCK on gforce to be evaluated which in-turn causes accvec to be evaluated.</p>
<p>The input to this feedback loop is the acceleration experienced by the ship (gforce) in terms of Kerbin&#8217;s gravitational acceleration at sea level (g). The variable accvec is the total acceleration vector and is obtained by the accelerometer and gravioli detectors, both of which must be on the ship for this to work. The variable dthrott is the change in throttle that should be applied in a single iteration of the feedback loop.</p>
<p>In terms of a PID loop, the factor 1.2 is called the setpoint, gforce is the process variable and 0.05 is called the proportional gain. The setpoint and gain factors can be promoted to their own variables with names. Also, the code up to and including the &#8220;WAIT UNTIL SHIP:ALTITUDE &gt; 1000.&#8221; will be implied for the next few examples of code:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="c1">// P-loop</span>
<span class="n">SET</span> <span class="n">g</span> <span class="n">TO</span> <span class="n">KERBIN</span><span class="o">:</span><span class="n">MU</span> <span class="o">/</span> <span class="n">KERBIN</span><span class="o">:</span><span class="n">RADIUS</span><span class="o">^</span><span class="mf">2.</span>
<span class="n">LOCK</span> <span class="n">accvec</span> <span class="n">TO</span> <span class="n">SHIP</span><span class="o">:</span><span class="n">SENSORS</span><span class="o">:</span><span class="n">ACC</span> <span class="o">-</span> <span class="n">SHIP</span><span class="o">:</span><span class="n">SENSORS</span><span class="o">:</span><span class="n">GRAV</span><span class="p">.</span>
<span class="n">LOCK</span> <span class="n">gforce</span> <span class="n">TO</span> <span class="n">accvec</span><span class="o">:</span><span class="n">MAG</span> <span class="o">/</span> <span class="n">g</span><span class="p">.</span>

<span class="n">SET</span> <span class="n">gforce_setpoint</span> <span class="n">TO</span> <span class="mf">1.2</span><span class="p">.</span>
<span class="n">SET</span> <span class="n">Kp</span> <span class="n">TO</span> <span class="mf">0.05</span><span class="p">.</span>
<span class="n">LOCK</span> <span class="n">dthrott</span> <span class="n">TO</span> <span class="n">Kp</span> <span class="o">*</span> <span class="p">(</span><span class="n">gforce_setpoint</span> <span class="o">-</span> <span class="n">gforce</span><span class="p">).</span>

<span class="n">SET</span> <span class="n">thrott</span> <span class="n">TO</span> <span class="mf">1.</span>
<span class="n">LOCK</span> <span class="n">THROTTLE</span> <span class="n">to</span> <span class="n">thrott</span><span class="p">.</span>

<span class="n">UNTIL</span> <span class="n">SHIP</span><span class="o">:</span><span class="n">ALTITUDE</span> <span class="o">&gt;</span> <span class="mi">40000</span> <span class="p">{</span>
    <span class="n">SET</span> <span class="n">thrott</span> <span class="n">to</span> <span class="n">thrott</span> <span class="o">+</span> <span class="n">dthrott</span><span class="p">.</span>
    <span class="n">WAIT</span> <span class="mf">0.1</span><span class="p">.</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This is not a big change, but it will set us up to include the integral and derivative terms in the next section.</p>
</div>
<div class="section" id="proportional-integral-feedback-loop-pi-loop">
<h2><a class="toc-backref" href="#id2">Proportional-Integral Feedback Loop (PI-loop)</a><a class="headerlink" href="#proportional-integral-feedback-loop-pi-loop" title="Permalink to this headline">¶</a></h2>
<p>Adding the integral term requires us to keep track of time. This is done by introducing a variable (t0) to store the time of the last iteration. Now, the throttle is changed only on iterations where some time has elapsed so the WAIT time in the UNTIL can be brought to 0.001. The offset of the gforce has been set to the variable P, and the integral gain to Ki.</p>
<div class="highlight-c"><div class="highlight"><pre><span class="c1">// PI-loop</span>
<span class="n">SET</span> <span class="n">g</span> <span class="n">TO</span> <span class="n">KERBIN</span><span class="o">:</span><span class="n">MU</span> <span class="o">/</span> <span class="n">KERBIN</span><span class="o">:</span><span class="n">RADIUS</span><span class="o">^</span><span class="mf">2.</span>
<span class="n">LOCK</span> <span class="n">accvec</span> <span class="n">TO</span> <span class="n">SHIP</span><span class="o">:</span><span class="n">SENSORS</span><span class="o">:</span><span class="n">ACC</span> <span class="o">-</span> <span class="n">SHIP</span><span class="o">:</span><span class="n">SENSORS</span><span class="o">:</span><span class="n">GRAV</span><span class="p">.</span>
<span class="n">LOCK</span> <span class="n">gforce</span> <span class="n">TO</span> <span class="n">accvec</span><span class="o">:</span><span class="n">MAG</span> <span class="o">/</span> <span class="n">g</span><span class="p">.</span>

<span class="n">SET</span> <span class="n">gforce_setpoint</span> <span class="n">TO</span> <span class="mf">1.2</span><span class="p">.</span>

<span class="n">LOCK</span> <span class="n">P</span> <span class="n">TO</span> <span class="n">gforce_setpoint</span> <span class="o">-</span> <span class="n">gforce</span><span class="p">.</span>
<span class="n">SET</span> <span class="n">I</span> <span class="n">TO</span> <span class="mf">0.</span>

<span class="n">SET</span> <span class="n">Kp</span> <span class="n">TO</span> <span class="mf">0.01</span><span class="p">.</span>
<span class="n">SET</span> <span class="n">Ki</span> <span class="n">TO</span> <span class="mf">0.006</span><span class="p">.</span>

<span class="n">LOCK</span> <span class="n">dthrott</span> <span class="n">TO</span> <span class="n">Kp</span> <span class="o">*</span> <span class="n">P</span> <span class="o">+</span> <span class="n">Ki</span> <span class="o">*</span> <span class="n">I</span><span class="p">.</span>

<span class="n">SET</span> <span class="n">thrott</span> <span class="n">TO</span> <span class="mf">1.</span>
<span class="n">LOCK</span> <span class="n">THROTTLE</span> <span class="n">to</span> <span class="n">thrott</span><span class="p">.</span>

<span class="n">SET</span> <span class="n">t0</span> <span class="n">TO</span> <span class="n">TIME</span><span class="o">:</span><span class="n">SECONDS</span><span class="p">.</span>
<span class="n">UNTIL</span> <span class="n">SHIP</span><span class="o">:</span><span class="n">ALTITUDE</span> <span class="o">&gt;</span> <span class="mi">40000</span> <span class="p">{</span>
    <span class="n">SET</span> <span class="n">dt</span> <span class="n">TO</span> <span class="n">TIME</span><span class="o">:</span><span class="n">SECONDS</span> <span class="o">-</span> <span class="n">t0</span><span class="p">.</span>
    <span class="n">IF</span> <span class="n">dt</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="n">SET</span> <span class="n">I</span> <span class="n">TO</span> <span class="n">I</span> <span class="o">+</span> <span class="n">P</span> <span class="o">*</span> <span class="n">dt</span><span class="p">.</span>
        <span class="n">SET</span> <span class="n">thrott</span> <span class="n">to</span> <span class="n">thrott</span> <span class="o">+</span> <span class="n">dthrott</span><span class="p">.</span>
        <span class="n">SET</span> <span class="n">t0</span> <span class="n">TO</span> <span class="n">TIME</span><span class="o">:</span><span class="n">SECONDS</span><span class="p">.</span>
    <span class="p">}</span>
    <span class="n">WAIT</span> <span class="mf">0.001</span><span class="p">.</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Adding the integral term has the general effect of stabilizing the feedback loop, making it less prone to oscillating due to rapid changes in the process variable (gforce, in this case). This is usually at the expense of a longer settling time.</p>
</div>
<div class="section" id="proportional-integral-derivative-feedback-loop-pid-loop">
<h2><a class="toc-backref" href="#id3">Proportional-Integral-Derivative Feedback Loop (PID-loop)</a><a class="headerlink" href="#proportional-integral-derivative-feedback-loop-pid-loop" title="Permalink to this headline">¶</a></h2>
<p>Incorporating the derivative term (D) and derivative gain (Kd) requires an additional variable (P0) to keep track of the previous value of the proportional term (P).</p>
<div class="highlight-c"><div class="highlight"><pre><span class="c1">// PID-loop</span>
<span class="n">SET</span> <span class="n">g</span> <span class="n">TO</span> <span class="n">KERBIN</span><span class="o">:</span><span class="n">MU</span> <span class="o">/</span> <span class="n">KERBIN</span><span class="o">:</span><span class="n">RADIUS</span><span class="o">^</span><span class="mf">2.</span>
<span class="n">LOCK</span> <span class="n">accvec</span> <span class="n">TO</span> <span class="n">SHIP</span><span class="o">:</span><span class="n">SENSORS</span><span class="o">:</span><span class="n">ACC</span> <span class="o">-</span> <span class="n">SHIP</span><span class="o">:</span><span class="n">SENSORS</span><span class="o">:</span><span class="n">GRAV</span><span class="p">.</span>
<span class="n">LOCK</span> <span class="n">gforce</span> <span class="n">TO</span> <span class="n">accvec</span><span class="o">:</span><span class="n">MAG</span> <span class="o">/</span> <span class="n">g</span><span class="p">.</span>

<span class="n">SET</span> <span class="n">gforce_setpoint</span> <span class="n">TO</span> <span class="mf">1.2</span><span class="p">.</span>

<span class="n">LOCK</span> <span class="n">P</span> <span class="n">TO</span> <span class="n">gforce_setpoint</span> <span class="o">-</span> <span class="n">gforce</span><span class="p">.</span>
<span class="n">SET</span> <span class="n">I</span> <span class="n">TO</span> <span class="mf">0.</span>
<span class="n">SET</span> <span class="n">D</span> <span class="n">TO</span> <span class="mf">0.</span>
<span class="n">SET</span> <span class="n">P0</span> <span class="n">TO</span> <span class="n">P</span><span class="p">.</span>

<span class="n">SET</span> <span class="n">Kp</span> <span class="n">TO</span> <span class="mf">0.01</span><span class="p">.</span>
<span class="n">SET</span> <span class="n">Ki</span> <span class="n">TO</span> <span class="mf">0.006</span><span class="p">.</span>
<span class="n">SET</span> <span class="n">Kd</span> <span class="n">TO</span> <span class="mf">0.006</span><span class="p">.</span>

<span class="n">LOCK</span> <span class="n">dthrott</span> <span class="n">TO</span> <span class="n">Kp</span> <span class="o">*</span> <span class="n">P</span> <span class="o">+</span> <span class="n">Ki</span> <span class="o">*</span> <span class="n">I</span> <span class="o">+</span> <span class="n">Kd</span> <span class="o">*</span> <span class="n">D</span><span class="p">.</span>

<span class="n">SET</span> <span class="n">thrott</span> <span class="n">TO</span> <span class="mf">1.</span>
<span class="n">LOCK</span> <span class="n">THROTTLE</span> <span class="n">to</span> <span class="n">thrott</span><span class="p">.</span>

<span class="n">SET</span> <span class="n">t0</span> <span class="n">TO</span> <span class="n">TIME</span><span class="o">:</span><span class="n">SECONDS</span><span class="p">.</span>
<span class="n">UNTIL</span> <span class="n">SHIP</span><span class="o">:</span><span class="n">ALTITUDE</span> <span class="o">&gt;</span> <span class="mi">40000</span> <span class="p">{</span>
    <span class="n">SET</span> <span class="n">dt</span> <span class="n">TO</span> <span class="n">TIME</span><span class="o">:</span><span class="n">SECONDS</span> <span class="o">-</span> <span class="n">t0</span><span class="p">.</span>
    <span class="n">IF</span> <span class="n">dt</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="n">SET</span> <span class="n">I</span> <span class="n">TO</span> <span class="n">I</span> <span class="o">+</span> <span class="n">P</span> <span class="o">*</span> <span class="n">dt</span><span class="p">.</span>
        <span class="n">SET</span> <span class="n">D</span> <span class="n">TO</span> <span class="p">(</span><span class="n">P</span> <span class="o">-</span> <span class="n">P0</span><span class="p">)</span> <span class="o">/</span> <span class="n">dt</span><span class="p">.</span>
        <span class="n">SET</span> <span class="n">thrott</span> <span class="n">to</span> <span class="n">thrott</span> <span class="o">+</span> <span class="n">dthrott</span><span class="p">.</span>
        <span class="n">SET</span> <span class="n">P0</span> <span class="n">TO</span> <span class="n">P</span><span class="p">.</span>
        <span class="n">SET</span> <span class="n">t0</span> <span class="n">TO</span> <span class="n">TIME</span><span class="o">:</span><span class="n">SECONDS</span><span class="p">.</span>
    <span class="p">}</span>
    <span class="n">WAIT</span> <span class="mf">0.001</span><span class="p">.</span>
<span class="p">}</span>
</pre></div>
</div>
<p>When tuned properly, the derivative term will cause the PID-loop to act quickly without causing problematic oscillations. Later in this tutorial, we will cover a way to tune a PID-loop using only the proportional term called the Zieger-Nichols method.</p>
</div>
<div class="section" id="final-touches">
<h2><a class="toc-backref" href="#id4">Final Touches</a><a class="headerlink" href="#final-touches" title="Permalink to this headline">¶</a></h2>
<p>There are a few modifications that can make PID loops very robust. The following code example adds three range limits:</p>
<ol class="arabic simple">
<li>bounds on the Integral term which addresses possible <a class="reference external" href="http://en.wikipedia.org/wiki/Integral_windup">integral windup</a></li>
<li>bounds on the throttle since it must stay in the range 0 to 1</li>
<li>a <a class="reference external" href="http://en.wikipedia.org/wiki/Deadband">deadband</a> to avoid changing the throttle due to small fluctuations</li>
</ol>
<p>Of course, KSP is a simulator and small fluctuations are not observed in this particular loop. Indeed, the P-loop is sufficient in this example, but all these features are included here for illustration purposes and they could become useful for unstable aircraft or untested scenarios.</p>
<div class="highlight-c"><div class="highlight"><pre><span class="c1">// PID-loop</span>
<span class="n">SET</span> <span class="n">g</span> <span class="n">TO</span> <span class="n">KERBIN</span><span class="o">:</span><span class="n">MU</span> <span class="o">/</span> <span class="n">KERBIN</span><span class="o">:</span><span class="n">RADIUS</span><span class="o">^</span><span class="mf">2.</span>
<span class="n">LOCK</span> <span class="n">accvec</span> <span class="n">TO</span> <span class="n">SHIP</span><span class="o">:</span><span class="n">SENSORS</span><span class="o">:</span><span class="n">ACC</span> <span class="o">-</span> <span class="n">SHIP</span><span class="o">:</span><span class="n">SENSORS</span><span class="o">:</span><span class="n">GRAV</span><span class="p">.</span>
<span class="n">LOCK</span> <span class="n">gforce</span> <span class="n">TO</span> <span class="n">accvec</span><span class="o">:</span><span class="n">MAG</span> <span class="o">/</span> <span class="n">g</span><span class="p">.</span>

<span class="n">SET</span> <span class="n">gforce_setpoint</span> <span class="n">TO</span> <span class="mf">1.2</span><span class="p">.</span>

<span class="n">LOCK</span> <span class="n">P</span> <span class="n">TO</span> <span class="n">gforce_setpoint</span> <span class="o">-</span> <span class="n">gforce</span><span class="p">.</span>
<span class="n">SET</span> <span class="n">I</span> <span class="n">TO</span> <span class="mf">0.</span>
<span class="n">SET</span> <span class="n">D</span> <span class="n">TO</span> <span class="mf">0.</span>
<span class="n">SET</span> <span class="n">P0</span> <span class="n">TO</span> <span class="n">P</span><span class="p">.</span>

<span class="n">LOCK</span> <span class="n">in_deadband</span> <span class="n">TO</span> <span class="n">ABS</span><span class="p">(</span><span class="n">P</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">.</span>

<span class="n">SET</span> <span class="n">Kp</span> <span class="n">TO</span> <span class="mf">0.01</span><span class="p">.</span>
<span class="n">SET</span> <span class="n">Ki</span> <span class="n">TO</span> <span class="mf">0.006</span><span class="p">.</span>
<span class="n">SET</span> <span class="n">Kd</span> <span class="n">TO</span> <span class="mf">0.006</span><span class="p">.</span>

<span class="n">LOCK</span> <span class="n">dthrott</span> <span class="n">TO</span> <span class="n">Kp</span> <span class="o">*</span> <span class="n">P</span> <span class="o">+</span> <span class="n">Ki</span> <span class="o">*</span> <span class="n">I</span> <span class="o">+</span> <span class="n">Kd</span> <span class="o">*</span> <span class="n">D</span><span class="p">.</span>

<span class="n">SET</span> <span class="n">thrott</span> <span class="n">TO</span> <span class="mf">1.</span>
<span class="n">LOCK</span> <span class="n">THROTTLE</span> <span class="n">to</span> <span class="n">thrott</span><span class="p">.</span>

<span class="n">SET</span> <span class="n">t0</span> <span class="n">TO</span> <span class="n">TIME</span><span class="o">:</span><span class="n">SECONDS</span><span class="p">.</span>
<span class="n">UNTIL</span> <span class="n">SHIP</span><span class="o">:</span><span class="n">ALTITUDE</span> <span class="o">&gt;</span> <span class="mi">40000</span> <span class="p">{</span>
    <span class="n">SET</span> <span class="n">dt</span> <span class="n">TO</span> <span class="n">TIME</span><span class="o">:</span><span class="n">SECONDS</span> <span class="o">-</span> <span class="n">t0</span><span class="p">.</span>
    <span class="n">IF</span> <span class="n">dt</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="n">IF</span> <span class="n">NOT</span> <span class="n">in_deadband</span> <span class="p">{</span>
            <span class="n">SET</span> <span class="n">I</span> <span class="n">TO</span> <span class="n">I</span> <span class="o">+</span> <span class="n">P</span> <span class="o">*</span> <span class="n">dt</span><span class="p">.</span>
            <span class="n">SET</span> <span class="n">D</span> <span class="n">TO</span> <span class="p">(</span><span class="n">P</span> <span class="o">-</span> <span class="n">P0</span><span class="p">)</span> <span class="o">/</span> <span class="n">dt</span><span class="p">.</span>

            <span class="c1">// If Ki is non-zero, then limit Ki*I to [-1,1]</span>
            <span class="n">IF</span> <span class="n">Ki</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
                <span class="n">SET</span> <span class="n">I</span> <span class="n">TO</span> <span class="n">MIN</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">Ki</span><span class="p">,</span> <span class="n">MAX</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="o">/</span><span class="n">Ki</span><span class="p">,</span> <span class="n">I</span><span class="p">)).</span>
            <span class="p">}</span>

            <span class="c1">// set throttle but keep in range [0,1]</span>
            <span class="n">SET</span> <span class="n">thrott</span> <span class="n">to</span> <span class="n">MIN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">MAX</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">thrott</span> <span class="o">+</span> <span class="n">dthrott</span><span class="p">)).</span>

            <span class="n">SET</span> <span class="n">P0</span> <span class="n">TO</span> <span class="n">P</span><span class="p">.</span>
            <span class="n">SET</span> <span class="n">t0</span> <span class="n">TO</span> <span class="n">TIME</span><span class="o">:</span><span class="n">SECONDS</span><span class="p">.</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">WAIT</span> <span class="mf">0.001</span><span class="p">.</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="tuning-a-pid-loop">
<h2><a class="toc-backref" href="#id5">Tuning a PID-loop</a><a class="headerlink" href="#tuning-a-pid-loop" title="Permalink to this headline">¶</a></h2>
<p>We are going to start with the same rocket design we have been using so far and actually tune the PID-loop using the Ziegler-Nichols method. This is where we turn off the integral and derivative terms in the loop and bring the proportional gain (Kp) up from zero to the point where the loop causes a steady oscillation with a measured period (Tu). At this point, the proportional gain is called the &#8220;ultimate gain&#8221; (Ku) and the actual gains (Kp, Ki and Kd) are set according to this table <a class="reference external" href="http://en.wikipedia.org/wiki/Ziegler%E2%80%93Nichols_method">taken from wikipedia</a>:</p>
<table border="1" class="docutils">
<colgroup>
<col width="38%" />
<col width="17%" />
<col width="23%" />
<col width="22%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Control Type</th>
<th class="head">Kp</th>
<th class="head">Ki</th>
<th class="head">Kd</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>P</td>
<td>0.5 Ku</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
</tr>
<tr class="row-odd"><td>PI</td>
<td>0.45 Ku</td>
<td>1.2 Kp / Tu</td>
<td>&nbsp;</td>
</tr>
<tr class="row-even"><td>PD</td>
<td>0.8 Ku</td>
<td>&nbsp;</td>
<td>Kp Tu / 8</td>
</tr>
<tr class="row-odd"><td>classic PID</td>
<td>0.6 Ku</td>
<td>2 Kp / Tu</td>
<td>Kp Tu / 8</td>
</tr>
<tr class="row-even"><td>Pessen Integral Rule</td>
<td>0.7 Ku</td>
<td>0.4 Kp / Tu</td>
<td>0.15 Kp Tu</td>
</tr>
<tr class="row-odd"><td>some overshoot</td>
<td>0.33 Ku</td>
<td>2 Kp / Tu</td>
<td>Kp Tu / 3</td>
</tr>
<tr class="row-even"><td>no overshoot</td>
<td>0.2 Ku</td>
<td>2 Kp / Tu</td>
<td>Kp Tu / 3</td>
</tr>
</tbody>
</table>
<p>An immediate problem to overcome with this method is that it assumes a steady state can be achieved. With rockets, there is never a steady state: fuel is being consumed, altitude and therefore gravity and atmosphere is changing, staging can cause major upsets in the feedback loop. So, this tuning method will be some approximation which should come as no surprise since it will come from experimental observation. All we need is enough of a steady state that we can measure the oscillations - both the change in amplitude and the period.</p>
<p>The script we&#8217;ll use to tune the highly overpowered rocket shown will launch the rocket straight up (using SAS) and will log data to an output file until it reaches 30km at which point the log file will be copied to the archive and the program will terminate. Also, this time the feedback loop will be based on the more realistic &#8220;atmospheric efficiency.&#8221; The log file will contain three columns: time since launch, offset of atmospheric efficiency from the ideal (in this case, 1.0) and the ship&#8217;s maximum thrust. The maximum thrust will increase monotonically with time (this rocket has only one stage) and we&#8217;ll use both as the x-axis when plotting the offset on the y-axis.</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">DECLARE</span> <span class="n">PARAMETER</span> <span class="n">Kp</span><span class="p">.</span>

<span class="n">LOCK</span> <span class="n">g</span> <span class="n">TO</span> <span class="n">SHIP</span><span class="o">:</span><span class="n">BODY</span><span class="o">:</span><span class="n">MU</span> <span class="o">/</span> <span class="p">(</span><span class="n">SHIP</span><span class="o">:</span><span class="n">BODY</span><span class="o">:</span><span class="n">RADIUS</span> <span class="o">+</span> <span class="n">SHIP</span><span class="o">:</span><span class="n">ALTITUDE</span><span class="p">)</span><span class="o">^</span><span class="mf">2.</span>
<span class="n">LOCK</span> <span class="n">maxtwr</span> <span class="n">TO</span> <span class="n">SHIP</span><span class="o">:</span><span class="n">MAXTHRUST</span> <span class="o">/</span> <span class="p">(</span><span class="n">g</span> <span class="o">*</span> <span class="n">SHIP</span><span class="o">:</span><span class="n">MASS</span><span class="p">).</span>

<span class="c1">// feedback based on atmospheric efficiency</span>
<span class="n">LOCK</span> <span class="n">surfspeed</span> <span class="n">TO</span> <span class="n">SHIP</span><span class="o">:</span><span class="n">VELOCITY</span><span class="o">:</span><span class="n">SURFACE</span><span class="o">:</span><span class="n">MAG</span><span class="p">.</span>
<span class="n">LOCK</span> <span class="n">atmoeff</span> <span class="n">TO</span> <span class="n">surfspeed</span> <span class="o">/</span> <span class="n">SHIP</span><span class="o">:</span><span class="n">TERMVELOCITY</span><span class="p">.</span>
<span class="n">LOCK</span> <span class="n">P</span> <span class="n">TO</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">atmoeff</span><span class="p">.</span>

<span class="n">SET</span> <span class="n">t0</span> <span class="n">TO</span> <span class="n">TIME</span><span class="o">:</span><span class="n">SECONDS</span><span class="p">.</span>
<span class="n">LOCK</span> <span class="n">dthrott</span> <span class="n">TO</span> <span class="n">Kp</span><span class="o">*</span><span class="n">P</span><span class="p">.</span>
<span class="n">SET</span> <span class="n">start_time</span> <span class="n">TO</span> <span class="n">t0</span><span class="p">.</span>

<span class="n">LOG</span> <span class="s">&quot;# Throttle PID Tuning&quot;</span> <span class="n">TO</span> <span class="n">throttle_log</span><span class="p">.</span>
<span class="n">LOG</span> <span class="s">&quot;# Kp: &quot;</span> <span class="o">+</span> <span class="n">Kp</span> <span class="n">TO</span> <span class="n">throttle_log</span><span class="p">.</span>
<span class="n">LOG</span> <span class="s">&quot;# t P maxtwr&quot;</span> <span class="n">TO</span> <span class="n">throttle_log</span><span class="p">.</span>

<span class="n">LOCK</span> <span class="n">logline</span> <span class="n">TO</span> <span class="p">(</span><span class="n">TIME</span><span class="o">:</span><span class="n">SECONDS</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span>
        <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="n">P</span>
        <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="n">maxtwr</span><span class="p">.</span>

<span class="n">SET</span> <span class="n">thrott</span> <span class="n">TO</span> <span class="mf">1.</span>
<span class="n">LOCK</span> <span class="n">THROTTLE</span> <span class="n">TO</span> <span class="n">thrott</span><span class="p">.</span>
<span class="n">SAS</span> <span class="n">ON</span><span class="p">.</span>
<span class="n">STAGE</span><span class="p">.</span>
<span class="n">WAIT</span> <span class="mf">3.</span>

<span class="n">UNTIL</span> <span class="n">SHIP</span><span class="o">:</span><span class="n">ALTITUDE</span> <span class="o">&gt;</span> <span class="mi">30000</span> <span class="p">{</span>
    <span class="n">SET</span> <span class="n">dt</span> <span class="n">TO</span> <span class="n">TIME</span><span class="o">:</span><span class="n">SECONDS</span> <span class="o">-</span> <span class="n">t0</span><span class="p">.</span>
    <span class="n">IF</span> <span class="n">dt</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="n">SET</span> <span class="n">thrott</span> <span class="n">TO</span> <span class="n">MIN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">MAX</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">thrott</span> <span class="o">+</span> <span class="n">dthrott</span><span class="p">)).</span>
        <span class="n">SET</span> <span class="n">t0</span> <span class="n">TO</span> <span class="n">TIME</span><span class="o">:</span><span class="n">SECONDS</span><span class="p">.</span>
        <span class="n">LOG</span> <span class="n">logline</span> <span class="n">TO</span> <span class="n">throttle_log</span><span class="p">.</span>
    <span class="p">}</span>
    <span class="n">WAIT</span> <span class="mf">0.001</span><span class="p">.</span>
<span class="p">}</span>
<span class="n">COPY</span> <span class="n">throttle_log</span> <span class="n">TO</span> <span class="mf">0.</span>
</pre></div>
</div>
<p>Give this script a short name, something like &#8220;tune.txt&#8221; so that running is simple:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">copy</span> <span class="n">tune</span> <span class="n">from</span> <span class="mf">0.</span>
<span class="n">run</span> <span class="n">tune</span><span class="p">(</span><span class="mf">0.5</span><span class="p">).</span>
</pre></div>
</div>
<p>After every launch completes, you&#8217;ll have to go into the archive directory and rename the output logfile. Something like &#8220;throttle_log.txt&#8221; &#8211;&gt; &#8220;throttle.01.log&#8221; will help if you increment the index number each time. To analyze the data, plot the offset (P) as a function of time (t). Here, we show the results for three values of Kp: 0.002, 0.016 and 0.160, including the maximum TWR when Kp = 0.002 as the top x-axis. The maximum TWR dependence on time is different for the three values of Kp, but not by a lot.</p>
<div class="figure">
<img alt="../_images/pidtune1.png" src="../_images/pidtune1.png" />
</div>
<p>The value of 0.002 is obviously too low. The settling time is well over 20 seconds and the loop can&#8217;t keep up with the increase in terminal velocity at the higher altitudes reached after one minute. When Kp = 0.016, the behavior is far more well behaved, and though some oscillation exists, it&#8217;s damped and slow with a period of about 10 seconds. At Kp = 0.160, the oscillations are prominent and we can start to measure the change in amplitude along with the period of the oscillations. This plot shows the data for Kp = 0.160 from 20 to 40 seconds after ignition. The peaks are found and are fit to a line.</p>
<div class="figure">
<img alt="../_images/pidtune2.png" src="../_images/pidtune2.png" />
</div>
<p>This is done for each value of Kp and the slopes of the fitted lines are plotted as a function of Kp in the following plot:</p>
<div class="figure">
<img alt="../_images/pidtune3.png" src="../_images/pidtune3.png" />
</div>
<p>The period of oscillation was averaged over the interval and plotted on top of the amplitude change over time. Notice the turn over that occurs when Kp reaches approximately 0.26. This will mark the &#8220;ultimate gain&#8221; and 3.1 seconds will be used as the associated period of oscillation. It is left as an exercise for the reader to implement a full PID-loop using the classic PID values (see table above): Kp = 0.156, Ki = 0.101, Kd = 0.060, producing this behavior:</p>
<div class="figure">
<img alt="../_images/pidtune4.png" src="../_images/pidtune4.png" />
</div>
<p>As soon as the PID-loop was activated at 3 seconds after ignition, the throttle was cut. At approximately 7 seconds, the atmospheric efficiency dropped below 100% and the integral term started to climb back to zero. At 11 seconds, the engine was reignited and the feedback loop settled after about 20 seconds. The inset plot has the same axes as the parent and shows the long-term stability of the final PID-loop.</p>
</div>
<div class="section" id="final-thoughts">
<h2><a class="toc-backref" href="#id6">Final Thoughts</a><a class="headerlink" href="#final-thoughts" title="Permalink to this headline">¶</a></h2>
<p>The classic PID values used above are fairly aggressive and there is some overshoot at the beginning. This can be dealt with in many ways and is discussed on the <a class="reference external" href="http://en.wikipedia.org/wiki/PID_controller">wikipedia page about PID controllers</a>. For example, one might consider trying to implement a switch to a PD-loop when the integral term hits some limit, switching back once P crosses zero. The PID behavior should look like the following:</p>
<div class="figure">
<img alt="../_images/pidtune5.png" src="../_images/pidtune5.png" />
</div>
<p>Finally, Controlling the throttle of a rocket is perhaps the easiest thing to implement as a PID loop in KSP using kOS. The steering was largely ignored and the orientation was always up. When writing an autopilot for horizontal atmospheric flight, one will have to deal with the direction the ship is traveling using SHIP:HEADING as well as it&#8217;s orientation with SHIP:FACING. Additionally, there are the SHIP:ROTATION and SHIP:TRANSLATION vectors which can tell you the rate of change of the ship&#8217;s facing and heading respectively. The controls in this case are six-dimensional using SHIP:CONTROL with YAW, PITCH, ROLL, FORE, STARBOARD, TOP and MAINTHROTTLE.</p>
<p>The PID gain parameters are dependent on the characteristics of the ship being controlled. The size, shape, turning capability and maximum TWR should be considered when tuning a PID loop. Turning RCS on can also have an effect and you might consider changing the PID loop&#8217;s gain parameters every time to switch them on or off.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">PID Loops in kOS</a><ul>
<li><a class="reference internal" href="#proportional-feedback-loop-p-loop">Proportional Feedback Loop (P-loop)</a></li>
<li><a class="reference internal" href="#proportional-integral-feedback-loop-pi-loop">Proportional-Integral Feedback Loop (PI-loop)</a></li>
<li><a class="reference internal" href="#proportional-integral-derivative-feedback-loop-pid-loop">Proportional-Integral-Derivative Feedback Loop (PID-loop)</a></li>
<li><a class="reference internal" href="#final-touches">Final Touches</a></li>
<li><a class="reference internal" href="#tuning-a-pid-loop">Tuning a PID-loop</a></li>
<li><a class="reference internal" href="#final-thoughts">Final Thoughts</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="designpatterns.html"
                        title="previous chapter">Design Patterns and Considerations with kOS</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../general.html"
                        title="next chapter">General Topics</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/tutorials/pidloops.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../general.html" title="General Topics"
             >next</a> |</li>
        <li class="right" >
          <a href="designpatterns.html" title="Design Patterns and Considerations with kOS"
             >previous</a> |</li>
        <li><a href="../index.html">kOS 0.15.3 documentation</a> &raquo;</li>
          <li><a href="../tutorials.html" >Tutorials</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2014, Dunbaratu, erendrake, Originally By Nivekk.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>