<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Design Patterns and Considerations with kOS &mdash; kOS 0.15.3 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.15.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="top" title="kOS 0.15.3 documentation" href="../index.html" />
    <link rel="up" title="Tutorials" href="../tutorials.html" />
    <link rel="next" title="PID Loops in kOS" href="pidloops.html" />
    <link rel="prev" title="Quick Start Tutorial" href="quickstart.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="pidloops.html" title="PID Loops in kOS"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="quickstart.html" title="Quick Start Tutorial"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">kOS 0.15.3 documentation</a> &raquo;</li>
          <li><a href="../tutorials.html" accesskey="U">Tutorials</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="design-patterns-and-considerations-with-kos">
<span id="designpatterns"></span><h1>Design Patterns and Considerations with kOS<a class="headerlink" href="#design-patterns-and-considerations-with-kos" title="Permalink to this headline">¶</a></h1>
<p>There are many ways one can write a control program for a given scenario. The goal of this section is to help a novice kOS programmer, after having finished the <a class="reference internal" href="quickstart.html#quickstart"><em>Quick Start Tutorial</em></a>, to develop a sense of elegance and capability when writing his or her own kOS scripts. All of the examples in this tutorial may be tested by the reader using a rocket design similar to the following. Notice it carries an <a class="reference external" href="http://wiki.kerbalspaceprogram.com/wiki/Double-C_Seismic_Accelerometer">accelerometer</a> and the <a class="reference external" href="http://wiki.kerbalspaceprogram.com/wiki/GRAVMAX_Negative_Gravioli_Detector">negative gravioli detector</a> which are used in the second section. Don&#8217;t forget the kOS module as well!</p>
<div class="figure">
<img alt="../_images/designpatterns_rocket.png" src="../_images/designpatterns_rocket.png" />
</div>
<div class="contents local topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#the-major-design-patterns-of-kos-control-programs" id="id1">The Major Design Patterns of kOS Control Programs</a><ul>
<li><a class="reference internal" href="#sequential-programs" id="id2">1. Sequential Programs</a></li>
<li><a class="reference internal" href="#loops-with-condition-checking" id="id3">2. Loops with Condition Checking</a></li>
<li><a class="reference internal" href="#loops-with-triggers" id="id4">3. Loops with Triggers</a></li>
<li><a class="reference internal" href="#bringing-it-all-together" id="id5">Bringing It All Together</a></li>
</ul>
</li>
<li><a class="reference internal" href="#general-guidelines-for-kos-scripts" id="id6">General Guidelines for kOS Scripts</a><ul>
<li><a class="reference internal" href="#minimize-time-spent-in-when-then-blocks" id="id7">1. Minimize Time Spent in WHEN/THEN Blocks</a></li>
<li><a class="reference internal" href="#minimize-trigger-conditions" id="id8">2. Minimize Trigger Conditions</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="the-major-design-patterns-of-kos-control-programs">
<h2><a class="toc-backref" href="#id1">The Major Design Patterns of kOS Control Programs</a><a class="headerlink" href="#the-major-design-patterns-of-kos-control-programs" title="Permalink to this headline">¶</a></h2>
<p>The design of a program is usually determined by the flow-control statements used. I.e., the WHEN/THEN, ON, WAIT, UNTIL, IF and FOR constructs. Here is a list of the major styles of control programs that can be written in kOS:</p>
<ol class="arabic simple">
<li>Sequential</li>
<li>Loops with Condition Checking</li>
<li>Loops with Triggers</li>
</ol>
<p>Of course, one style does not fit all scenarios and the programmer will typically want to use a combination of these all at once. Also, there may be other design patterns not listed here which can be perfectly valid, but this is a start.</p>
<div class="section" id="sequential-programs">
<h3><a class="toc-backref" href="#id2">1. Sequential Programs</a><a class="headerlink" href="#sequential-programs" title="Permalink to this headline">¶</a></h3>
<p>These are programs that rely almost exclusively on WAIT UNTIL statements to go from one phase to the next.</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">LOCK</span> <span class="n">STEERING</span> <span class="n">TO</span> <span class="n">HEADING</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">90</span><span class="p">).</span>
<span class="n">LOCK</span> <span class="n">THROTTLE</span> <span class="n">TO</span> <span class="mf">1.</span>
<span class="n">STAGE</span><span class="p">.</span>
<span class="n">WAIT</span> <span class="n">UNTIL</span> <span class="n">SHIP</span><span class="o">:</span><span class="n">ALTITUDE</span> <span class="o">&gt;</span> <span class="mf">10000.</span>
<span class="n">LOCK</span> <span class="n">STEERING</span> <span class="n">TO</span> <span class="n">HEADING</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">90</span><span class="p">)</span> <span class="o">+</span> <span class="n">R</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">45</span><span class="p">,</span><span class="mi">0</span><span class="p">).</span>
<span class="n">WAIT</span> <span class="n">UNTIL</span> <span class="n">STAGE</span><span class="o">:</span><span class="n">LIQUIDFUEL</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">.</span>
<span class="n">STAGE</span><span class="p">.</span>
<span class="n">WAIT</span> <span class="n">UNTIL</span> <span class="n">SHIP</span><span class="o">:</span><span class="n">ALTITUDE</span> <span class="o">&gt;</span> <span class="mf">20000.</span>
<span class="n">LOCK</span> <span class="n">THROTTLE</span> <span class="n">TO</span> <span class="mf">0.</span>
<span class="n">WAIT</span> <span class="n">UNTIL</span> <span class="n">FALSE</span><span class="p">.</span> <span class="c1">// CTRL+C to break out</span>
</pre></div>
</div>
<p>This example will take a two stage rocket up to 20km. The immediate thing to notice is that the programmer must have known that the first stage would cutoff between 10km and 20km. This is fine for a specific rocket but not too general and could end in disaster if the first stage cutoff occurs at say 5km. Certainly, one can write a program using this technique to take a specific rocket, put it into orbit and even perform a lot of fancy maneuvers, but adapting the code to different rockets may get complicated quickly.</p>
</div>
<div class="section" id="loops-with-condition-checking">
<h3><a class="toc-backref" href="#id3">2. Loops with Condition Checking</a><a class="headerlink" href="#loops-with-condition-checking" title="Permalink to this headline">¶</a></h3>
<p>Here, we introduce IF/ELSE logic into UNTIL loops:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">LOCK</span> <span class="n">STEERING</span> <span class="n">TO</span> <span class="n">R</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">90</span><span class="p">)</span> <span class="o">+</span> <span class="n">HEADING</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span><span class="mi">90</span><span class="p">).</span>
<span class="n">LOCK</span> <span class="n">THROTTLE</span> <span class="n">TO</span> <span class="mf">1.</span>
<span class="n">STAGE</span><span class="p">.</span>
<span class="n">UNTIL</span> <span class="n">SHIP</span><span class="o">:</span><span class="n">ALTITUDE</span> <span class="o">&gt;</span> <span class="mi">20000</span> <span class="p">{</span>
    <span class="n">IF</span> <span class="n">SHIP</span><span class="o">:</span><span class="n">ALTITUDE</span> <span class="o">&gt;</span> <span class="mi">10000</span> <span class="p">{</span>
        <span class="n">LOCK</span> <span class="n">STEERING</span> <span class="n">TO</span> <span class="n">R</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">90</span><span class="p">)</span> <span class="o">+</span> <span class="n">HEADING</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span><span class="mi">45</span><span class="p">).</span>
    <span class="p">}</span>
    <span class="n">IF</span> <span class="n">STAGE</span><span class="o">:</span><span class="n">LIQUIDFUEL</span> <span class="o">&lt;</span> <span class="mf">0.1</span> <span class="p">{</span>
        <span class="n">STAGE</span><span class="p">.</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="n">LOCK</span> <span class="n">THROTTLE</span> <span class="n">TO</span> <span class="mf">0.</span>
<span class="n">WAIT</span> <span class="n">UNTIL</span> <span class="n">FALSE</span><span class="p">.</span>
</pre></div>
</div>
<p>This does the same thing as the previous example, but now it&#8217;s checking for a staging condition from the launch pad all the way to 20km. More than that, it will stage as many times as needed.</p>
<p>One can imagine that these types of UNTIL loops can become very complex with many layers of IF/ELSE blocks. Once this happens it is usually good to reduce the frequency of the loop by adding a WAIT statement at the end of the loop. This wait could be anywhere from 0.001 (every physics tick), to 60 (every minute) or even longer for inter-planetary transfers if desired.</p>
</div>
<div class="section" id="loops-with-triggers">
<h3><a class="toc-backref" href="#id4">3. Loops with Triggers</a><a class="headerlink" href="#loops-with-triggers" title="Permalink to this headline">¶</a></h3>
<p>In the above example, once the rocket reaches 10km, the steering is constantly being re-locked to HEADING(90,45). This works, but it only needs to be locked once. A possible improvement is to set up a trigger using a WHEN/THEN statement:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">LOCK</span> <span class="n">STEERING</span> <span class="n">TO</span> <span class="n">R</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">90</span><span class="p">)</span> <span class="o">+</span> <span class="n">HEADING</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span><span class="mi">90</span><span class="p">).</span>
<span class="n">LOCK</span> <span class="n">THROTTLE</span> <span class="n">TO</span> <span class="mf">1.</span>
<span class="n">STAGE</span><span class="p">.</span>
<span class="n">WHEN</span> <span class="n">SHIP</span><span class="o">:</span><span class="n">ALTITUDE</span> <span class="o">&gt;</span> <span class="mi">10000</span> <span class="n">THEN</span> <span class="p">{</span>
    <span class="n">LOCK</span> <span class="n">STEERING</span> <span class="n">TO</span> <span class="n">R</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">90</span><span class="p">)</span> <span class="o">+</span> <span class="n">HEADING</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span><span class="mi">45</span><span class="p">).</span>
<span class="p">}</span>
<span class="n">UNTIL</span> <span class="n">SHIP</span><span class="o">:</span><span class="n">ALTITUDE</span> <span class="o">&gt;</span> <span class="mi">20000</span> <span class="p">{</span>
    <span class="n">IF</span> <span class="n">STAGE</span><span class="o">:</span><span class="n">LIQUIDFUEL</span> <span class="o">&lt;</span> <span class="mf">0.1</span> <span class="p">{</span>
        <span class="n">STAGE</span><span class="p">.</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="n">LOCK</span> <span class="n">THROTTLE</span> <span class="n">TO</span> <span class="mf">0.</span>
<span class="n">WAIT</span> <span class="n">UNTIL</span> <span class="n">FALSE</span><span class="p">.</span>
</pre></div>
</div>
<p>Now, when the rocket reaches 10km, the steering is set once and the trigger is removed from the active list of triggers. The staging condition can also be promoted to a trigger, keeping the trigger active after every stage using the PRESERVE keyword:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">WHEN</span> <span class="n">STAGE</span><span class="o">:</span><span class="n">LIQUIDFUEL</span> <span class="o">&lt;</span> <span class="mf">0.1</span> <span class="n">THEN</span> <span class="p">{</span>
    <span class="n">STAGE</span><span class="p">.</span>
    <span class="n">PRESERVE</span><span class="p">.</span>
<span class="p">}</span>
<span class="n">LOCK</span> <span class="n">STEERING</span> <span class="n">TO</span> <span class="n">R</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">90</span><span class="p">)</span> <span class="o">+</span> <span class="n">HEADING</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span><span class="mi">90</span><span class="p">).</span>
<span class="n">LOCK</span> <span class="n">THROTTLE</span> <span class="n">TO</span> <span class="mf">1.</span>
<span class="n">STAGE</span><span class="p">.</span>
<span class="n">WHEN</span> <span class="n">SHIP</span><span class="o">:</span><span class="n">ALTITUDE</span> <span class="o">&gt;</span> <span class="mi">10000</span> <span class="n">THEN</span> <span class="p">{</span>
    <span class="n">LOCK</span> <span class="n">STEERING</span> <span class="n">TO</span> <span class="n">R</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">90</span><span class="p">)</span> <span class="o">+</span> <span class="n">HEADING</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span><span class="mi">45</span><span class="p">).</span>
<span class="p">}</span>
<span class="n">WAIT</span> <span class="n">UNTIL</span> <span class="n">SHIP</span><span class="o">:</span><span class="n">ALTITUDE</span> <span class="o">&gt;</span> <span class="mf">20000.</span>
<span class="n">LOCK</span> <span class="n">THROTTLE</span> <span class="n">TO</span> <span class="mf">0.</span>
<span class="n">WAIT</span> <span class="n">UNTIL</span> <span class="n">FALSE</span><span class="p">.</span>
</pre></div>
</div>
<p>Notice that the UNTIL loop was changed to a WAIT UNTIL statement since the program is small and all the logic of the triggers can be handled in a reasonable amount of time - there will be more on this topic later.</p>
</div>
<div class="section" id="bringing-it-all-together">
<h3><a class="toc-backref" href="#id5">Bringing It All Together</a><a class="headerlink" href="#bringing-it-all-together" title="Permalink to this headline">¶</a></h3>
<p>Typically, the programmer will find all of these constructs are useful at the same time and kOS scripts will naturally contain some sequential parts in combination with long-term and short-term triggers which can modify states in complex loops of varying frequency. If you didn&#8217;t follow that bit of gobbledygook, don&#8217;t worry. The next section will discuss a few recommendations for beginning kOS programmers to follow when setting up any program.</p>
</div>
</div>
<div class="section" id="general-guidelines-for-kos-scripts">
<h2><a class="toc-backref" href="#id6">General Guidelines for kOS Scripts</a><a class="headerlink" href="#general-guidelines-for-kos-scripts" title="Permalink to this headline">¶</a></h2>
<p>This section discusses two general guidelines to follow when starting out with more complicated kOS scripts. These are not meant to be absolute and there will certainly be cases when they can be stretched, though one should never totally ignore them.</p>
<div class="section" id="minimize-time-spent-in-when-then-blocks">
<h3><a class="toc-backref" href="#id7">1. Minimize Time Spent in WHEN/THEN Blocks</a><a class="headerlink" href="#minimize-time-spent-in-when-then-blocks" title="Permalink to this headline">¶</a></h3>
<p>Remember that WAIT statements are ignored when inside WHEN/THEN blocks. It is OK to loop over small lists (engines for example), but don&#8217;t let it get out of hand. The WHEN/THEN construct was designed to accommodate quick bits of code. Consider this bit of (non-working) code which tries to adjust the throttle based on the g-force as measured by a combination of the accelerometer and the negative gravioli detector:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">SET</span> <span class="n">thrott</span> <span class="n">TO</span> <span class="mf">1.</span>
<span class="n">LOCK</span> <span class="n">THROTTLE</span> <span class="n">TO</span> <span class="n">thrott</span><span class="p">.</span>
<span class="n">LOCK</span> <span class="n">STEERING</span> <span class="n">TO</span> <span class="n">R</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">90</span><span class="p">)</span> <span class="o">+</span> <span class="n">HEADING</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span><span class="mi">90</span><span class="p">).</span>
<span class="n">STAGE</span><span class="p">.</span>
<span class="n">WHEN</span> <span class="n">SHIP</span><span class="o">:</span><span class="n">ALTITUDE</span> <span class="o">&gt;</span> <span class="mi">1000</span> <span class="n">THEN</span> <span class="p">{</span>
    <span class="n">SET</span> <span class="n">g</span> <span class="n">TO</span> <span class="n">KERBIN</span><span class="o">:</span><span class="n">MU</span> <span class="o">/</span> <span class="n">KERBIN</span><span class="o">:</span><span class="n">RADIUS</span><span class="o">^</span><span class="mf">2.</span>
    <span class="n">LOCK</span> <span class="n">accvec</span> <span class="n">TO</span> <span class="n">SHIP</span><span class="o">:</span><span class="n">SENSORS</span><span class="o">:</span><span class="n">ACC</span> <span class="o">-</span> <span class="n">SHIP</span><span class="o">:</span><span class="n">SENSORS</span><span class="o">:</span><span class="n">GRAV</span><span class="p">.</span>
    <span class="n">LOCK</span> <span class="n">gforce</span> <span class="n">TO</span> <span class="n">accvec</span><span class="o">:</span><span class="n">MAG</span> <span class="o">/</span> <span class="n">g</span><span class="p">.</span>
    <span class="n">LOCK</span> <span class="n">dthrott</span> <span class="n">TO</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.2</span> <span class="o">-</span> <span class="n">gforce</span><span class="p">).</span>

    <span class="n">UNTIL</span> <span class="n">SHIP</span><span class="o">:</span><span class="n">ALTITUDE</span> <span class="o">&gt;</span> <span class="mi">40000</span> <span class="p">{</span>
        <span class="n">WHEN</span> <span class="n">STAGE</span><span class="o">:</span><span class="n">LIQUIDFUEL</span> <span class="o">&lt;</span> <span class="mf">0.1</span> <span class="n">THEN</span> <span class="p">{</span>
            <span class="n">STAGE</span><span class="p">.</span>
            <span class="n">PRESERVE</span><span class="p">.</span>
        <span class="p">}</span>
        <span class="n">SET</span> <span class="n">thrott</span> <span class="n">to</span> <span class="n">thrott</span> <span class="o">+</span> <span class="n">dthrott</span><span class="p">.</span>
        <span class="n">WAIT</span> <span class="mf">0.1</span><span class="p">.</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This looks reasonable. The throttle is set to maximum until 1km is reached at which point the throttle is adjusted every 0.1 seconds. If the gforce is off from the value of 1.2, then the throttle is either increased or decreased by a small amount. Running this on a test rocket merely produce the message &#8220;Program ended.&#8221;</p>
<p>Understanding why this does not work is important. Everything in a WHEN/THEN block is expected to complete in the current physics tick, but here we have a loop that is supposed to last until the ship reaches 40km. This example can be reworked by separating the triggers from the loop. The staging trigger was separated from the UNTIL loop as well - not strictly necessary, but recommended form:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">WHEN</span> <span class="n">STAGE</span><span class="o">:</span><span class="n">LIQUIDFUEL</span> <span class="o">&lt;</span> <span class="mf">0.1</span> <span class="n">THEN</span> <span class="p">{</span>
    <span class="n">STAGE</span><span class="p">.</span>
    <span class="n">PRESERVE</span><span class="p">.</span>
<span class="p">}</span>
<span class="n">SET</span> <span class="n">thrott</span> <span class="n">TO</span> <span class="mf">1.</span>
<span class="n">SET</span> <span class="n">dthrott</span> <span class="n">TO</span> <span class="mf">0.</span>
<span class="n">LOCK</span> <span class="n">THROTTLE</span> <span class="n">TO</span> <span class="n">thrott</span><span class="p">.</span>
<span class="n">LOCK</span> <span class="n">STEERING</span> <span class="n">TO</span> <span class="n">R</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">90</span><span class="p">)</span> <span class="o">+</span> <span class="n">HEADING</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span><span class="mi">90</span><span class="p">).</span>
<span class="n">STAGE</span><span class="p">.</span>
<span class="n">WHEN</span> <span class="n">SHIP</span><span class="o">:</span><span class="n">ALTITUDE</span> <span class="o">&gt;</span> <span class="mi">1000</span> <span class="n">THEN</span> <span class="p">{</span>
    <span class="n">SET</span> <span class="n">g</span> <span class="n">TO</span> <span class="n">KERBIN</span><span class="o">:</span><span class="n">MU</span> <span class="o">/</span> <span class="n">KERBIN</span><span class="o">:</span><span class="n">RADIUS</span><span class="o">^</span><span class="mf">2.</span>
    <span class="n">LOCK</span> <span class="n">accvec</span> <span class="n">TO</span> <span class="n">SHIP</span><span class="o">:</span><span class="n">SENSORS</span><span class="o">:</span><span class="n">ACC</span> <span class="o">-</span> <span class="n">SHIP</span><span class="o">:</span><span class="n">SENSORS</span><span class="o">:</span><span class="n">GRAV</span><span class="p">.</span>
    <span class="n">LOCK</span> <span class="n">gforce</span> <span class="n">TO</span> <span class="n">accvec</span><span class="o">:</span><span class="n">MAG</span> <span class="o">/</span> <span class="n">g</span><span class="p">.</span>
    <span class="n">LOCK</span> <span class="n">dthrott</span> <span class="n">TO</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.2</span> <span class="o">-</span> <span class="n">gforce</span><span class="p">).</span>
<span class="p">}</span>
<span class="n">UNTIL</span> <span class="n">SHIP</span><span class="o">:</span><span class="n">ALTITUDE</span> <span class="o">&gt;</span> <span class="mi">40000</span> <span class="p">{</span>
    <span class="n">SET</span> <span class="n">thrott</span> <span class="n">to</span> <span class="n">thrott</span> <span class="o">+</span> <span class="n">dthrott</span><span class="p">.</span>
    <span class="n">WAIT</span> <span class="mf">0.1</span><span class="p">.</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now this program should work. The variable dthrott had to be set to 0 in the beginning so that the throttle is kept at maximum until 1km, the UNTIL loop operates every 0.1 seconds, and the WHEN/THEN triggers are run only once when the condition is met. The take-away from this example is to keep WHEN/THEN blocks separate from UNTIL loops. Specifically, never put an UNTIL loop inside a WHEN/THEN block and it should be extremely rare to put a WHEN/THEN statement inside an UNTIL loop.</p>
<p>Finally, as a bit of foreshadowing, this bit of code is actually a &#8220;<a class="reference external" href="http://en.wikipedia.org/wiki/PID_controller">proportional feedback loop</a>.&#8221; From an altitude of 1km up to 40km, the total g-force exerted on the ship is kept near 1.2 by constantly adjusting the throttle. The value of 1.2 is called the &#8220;setpoint,&#8221; the measured g-force is called the &#8220;process variable,&#8221; and the mystical 0.05 is called the &#8220;proportional gain.&#8221; Please take a look at the <a class="reference external" href="../pidloop_tutorial/index.html">PID Loop Tutorial</a> which takes this script as a starting point and develops a full PID-loop in kOS.</p>
</div>
<div class="section" id="minimize-trigger-conditions">
<h3><a class="toc-backref" href="#id8">2. Minimize Trigger Conditions</a><a class="headerlink" href="#minimize-trigger-conditions" title="Permalink to this headline">¶</a></h3>
<p>There is a lot of power in developing multi-level LOCK variables in combination with WHEN/THEN triggers. However, it can be easy to hit kOS&#8217;s hard limit in the number of operations allowed for trigger checking. This will happen when several WHEN/THEN triggers are dependent on the same complex LOCK variable. This results in the LOCK variable being calculated multiple times every update. If the LOCK is deep enough, the calculations become too expensive to do and kOS stops executing and complains.</p>
<p>With this in mind, consider an extension of the example script in the previous section. This time, the g-force setpoint changes as the rocket climbs through 10km, 20km and 30km:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">WHEN</span> <span class="n">STAGE</span><span class="o">:</span><span class="n">LIQUIDFUEL</span> <span class="o">&lt;</span> <span class="mf">0.1</span> <span class="n">THEN</span> <span class="p">{</span>
    <span class="n">STAGE</span><span class="p">.</span>
    <span class="n">PRESERVE</span><span class="p">.</span>
<span class="p">}</span>
<span class="n">SET</span> <span class="n">thrott</span> <span class="n">TO</span> <span class="mf">1.</span>
<span class="n">SET</span> <span class="n">dthrott</span> <span class="n">TO</span> <span class="mf">0.</span>
<span class="n">LOCK</span> <span class="n">THROTTLE</span> <span class="n">TO</span> <span class="n">thrott</span><span class="p">.</span>
<span class="n">LOCK</span> <span class="n">STEERING</span> <span class="n">TO</span> <span class="n">R</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">90</span><span class="p">)</span> <span class="o">+</span> <span class="n">HEADING</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span><span class="mi">90</span><span class="p">).</span>
<span class="n">STAGE</span><span class="p">.</span>
<span class="n">WHEN</span> <span class="n">SHIP</span><span class="o">:</span><span class="n">ALTITUDE</span> <span class="o">&gt;</span> <span class="mi">1000</span> <span class="n">THEN</span> <span class="p">{</span>
    <span class="n">SET</span> <span class="n">g</span> <span class="n">TO</span> <span class="n">KERBIN</span><span class="o">:</span><span class="n">MU</span> <span class="o">/</span> <span class="n">KERBIN</span><span class="o">:</span><span class="n">RADIUS</span><span class="o">^</span><span class="mf">2.</span>
    <span class="n">LOCK</span> <span class="n">accvec</span> <span class="n">TO</span> <span class="n">SHIP</span><span class="o">:</span><span class="n">SENSORS</span><span class="o">:</span><span class="n">ACC</span> <span class="o">-</span> <span class="n">SHIP</span><span class="o">:</span><span class="n">SENSORS</span><span class="o">:</span><span class="n">GRAV</span><span class="p">.</span>
    <span class="n">LOCK</span> <span class="n">gforce</span> <span class="n">TO</span> <span class="n">accvec</span><span class="o">:</span><span class="n">MAG</span> <span class="o">/</span> <span class="n">g</span><span class="p">.</span>
    <span class="n">LOCK</span> <span class="n">dthrott</span> <span class="n">TO</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.2</span> <span class="o">-</span> <span class="n">gforce</span><span class="p">).</span>
<span class="p">}</span>
<span class="n">WHEN</span> <span class="n">SHIP</span><span class="o">:</span><span class="n">ALTITUDE</span> <span class="o">&gt;</span> <span class="mi">10000</span> <span class="n">THEN</span> <span class="p">{</span>
    <span class="n">LOCK</span> <span class="n">dthrott</span> <span class="n">TO</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">gforce</span><span class="p">).</span>
<span class="p">}</span>
<span class="n">WHEN</span> <span class="n">SHIP</span><span class="o">:</span><span class="n">ALTITUDE</span> <span class="o">&gt;</span> <span class="mi">20000</span> <span class="n">THEN</span> <span class="p">{</span>
    <span class="n">LOCK</span> <span class="n">dthrott</span> <span class="n">TO</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="p">(</span><span class="mf">4.0</span> <span class="o">-</span> <span class="n">gforce</span><span class="p">).</span>
<span class="p">}</span>
<span class="n">WHEN</span> <span class="n">SHIP</span><span class="o">:</span><span class="n">ALTITUDE</span> <span class="o">&gt;</span> <span class="mi">30000</span> <span class="n">THEN</span> <span class="p">{</span>
    <span class="n">LOCK</span> <span class="n">dthrott</span> <span class="n">TO</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="p">(</span><span class="mf">5.0</span> <span class="o">-</span> <span class="n">gforce</span><span class="p">).</span>
<span class="p">}</span>
<span class="n">UNTIL</span> <span class="n">SHIP</span><span class="o">:</span><span class="n">ALTITUDE</span> <span class="o">&gt;</span> <span class="mi">40000</span> <span class="p">{</span>
    <span class="n">SET</span> <span class="n">thrott</span> <span class="n">to</span> <span class="n">thrott</span> <span class="o">+</span> <span class="n">dthrott</span><span class="p">.</span>
    <span class="n">WAIT</span> <span class="mf">0.1</span><span class="p">.</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This example does what is expected of it without problems. But the ship&#8217;s altitude is being checked at least five times for every update, including the UNTIL loop check. Certaintly, the kOS CPU can keep up with this, however, one can imagine a whole series of WHEN/THEN statements which make use of complicated calculations based on atmospheric data or orbital mechanics. One way to minimize the trigger condition checking is to take strictly-sequential triggers and nest them:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">WHEN</span> <span class="n">STAGE</span><span class="o">:</span><span class="n">LIQUIDFUEL</span> <span class="o">&lt;</span> <span class="mf">0.1</span> <span class="n">THEN</span> <span class="p">{</span>
    <span class="n">STAGE</span><span class="p">.</span>
    <span class="n">PRESERVE</span><span class="p">.</span>
<span class="p">}</span>
<span class="n">SET</span> <span class="n">thrott</span> <span class="n">TO</span> <span class="mf">1.</span>
<span class="n">SET</span> <span class="n">dthrott</span> <span class="n">TO</span> <span class="mf">0.</span>
<span class="n">LOCK</span> <span class="n">THROTTLE</span> <span class="n">TO</span> <span class="n">thrott</span><span class="p">.</span>
<span class="n">LOCK</span> <span class="n">STEERING</span> <span class="n">TO</span> <span class="n">R</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">90</span><span class="p">)</span> <span class="o">+</span> <span class="n">HEADING</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span><span class="mi">90</span><span class="p">).</span>
<span class="n">STAGE</span><span class="p">.</span>
<span class="n">WHEN</span> <span class="n">SHIP</span><span class="o">:</span><span class="n">ALTITUDE</span> <span class="o">&gt;</span> <span class="mi">1000</span> <span class="n">THEN</span> <span class="p">{</span>
    <span class="n">SET</span> <span class="n">g</span> <span class="n">TO</span> <span class="n">KERBIN</span><span class="o">:</span><span class="n">MU</span> <span class="o">/</span> <span class="n">KERBIN</span><span class="o">:</span><span class="n">RADIUS</span><span class="o">^</span><span class="mf">2.</span>
    <span class="n">LOCK</span> <span class="n">accvec</span> <span class="n">TO</span> <span class="n">SHIP</span><span class="o">:</span><span class="n">SENSORS</span><span class="o">:</span><span class="n">ACC</span> <span class="o">-</span> <span class="n">SHIP</span><span class="o">:</span><span class="n">SENSORS</span><span class="o">:</span><span class="n">GRAV</span><span class="p">.</span>
    <span class="n">LOCK</span> <span class="n">gforce</span> <span class="n">TO</span> <span class="n">accvec</span><span class="o">:</span><span class="n">MAG</span> <span class="o">/</span> <span class="n">g</span><span class="p">.</span>
    <span class="n">LOCK</span> <span class="n">dthrott</span> <span class="n">TO</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.2</span> <span class="o">-</span> <span class="n">gforce</span><span class="p">).</span>

    <span class="n">WHEN</span> <span class="n">SHIP</span><span class="o">:</span><span class="n">ALTITUDE</span> <span class="o">&gt;</span> <span class="mi">10000</span> <span class="n">THEN</span> <span class="p">{</span>
        <span class="n">LOCK</span> <span class="n">dthrott</span> <span class="n">TO</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">gforce</span><span class="p">).</span>

        <span class="n">WHEN</span> <span class="n">SHIP</span><span class="o">:</span><span class="n">ALTITUDE</span> <span class="o">&gt;</span> <span class="mi">20000</span> <span class="n">THEN</span> <span class="p">{</span>
            <span class="n">LOCK</span> <span class="n">dthrott</span> <span class="n">TO</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="p">(</span><span class="mf">4.0</span> <span class="o">-</span> <span class="n">gforce</span><span class="p">).</span>

            <span class="n">WHEN</span> <span class="n">SHIP</span><span class="o">:</span><span class="n">ALTITUDE</span> <span class="o">&gt;</span> <span class="mi">30000</span> <span class="n">THEN</span> <span class="p">{</span>
                <span class="n">LOCK</span> <span class="n">dthrott</span> <span class="n">TO</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="p">(</span><span class="mf">5.0</span> <span class="o">-</span> <span class="n">gforce</span><span class="p">).</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="n">UNTIL</span> <span class="n">SHIP</span><span class="o">:</span><span class="n">ALTITUDE</span> <span class="o">&gt;</span> <span class="mi">40000</span> <span class="p">{</span>
    <span class="n">SET</span> <span class="n">thrott</span> <span class="n">to</span> <span class="n">thrott</span> <span class="o">+</span> <span class="n">dthrott</span><span class="p">.</span>
    <span class="n">WAIT</span> <span class="mf">0.1</span><span class="p">.</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now this is quite elegant! The number of triggers have been reduced to two per update for the entire running of this script. The trigger at 1km sets up the next trigger which will happen at 10km which sets up then next at 20km and so on. This can save a lot of processing time for triggers that will happen sequentially. As a general rule, one should try to nest WHEN/THEN statements whenever possible. Again, both examples above will work, but when scripts start to have deep and complicated triggers, this nested construct can save it from the dreaded kOS trigger limit.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Design Patterns and Considerations with kOS</a><ul>
<li><a class="reference internal" href="#the-major-design-patterns-of-kos-control-programs">The Major Design Patterns of kOS Control Programs</a><ul>
<li><a class="reference internal" href="#sequential-programs">1. Sequential Programs</a></li>
<li><a class="reference internal" href="#loops-with-condition-checking">2. Loops with Condition Checking</a></li>
<li><a class="reference internal" href="#loops-with-triggers">3. Loops with Triggers</a></li>
<li><a class="reference internal" href="#bringing-it-all-together">Bringing It All Together</a></li>
</ul>
</li>
<li><a class="reference internal" href="#general-guidelines-for-kos-scripts">General Guidelines for kOS Scripts</a><ul>
<li><a class="reference internal" href="#minimize-time-spent-in-when-then-blocks">1. Minimize Time Spent in WHEN/THEN Blocks</a></li>
<li><a class="reference internal" href="#minimize-trigger-conditions">2. Minimize Trigger Conditions</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="quickstart.html"
                        title="previous chapter">Quick Start Tutorial</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="pidloops.html"
                        title="next chapter">PID Loops in kOS</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/tutorials/designpatterns.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="pidloops.html" title="PID Loops in kOS"
             >next</a> |</li>
        <li class="right" >
          <a href="quickstart.html" title="Quick Start Tutorial"
             >previous</a> |</li>
        <li><a href="../index.html">kOS 0.15.3 documentation</a> &raquo;</li>
          <li><a href="../tutorials.html" >Tutorials</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2014, Dunbaratu, erendrake, Originally By Nivekk.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>